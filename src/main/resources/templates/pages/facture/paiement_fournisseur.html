<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Details Facture Fournisseur</title>
    <link rel="stylesheet" th:href="@{/css/paiement.css}">
</head>
<body>
    <div class="main-container">
        <div class="invoice-details">
            <div class="section">
                <h2>Details Facture Fournisseur</h2>

                <div class="section-title">Fournisseur</div>
                <div class="form-field">
                    <label>Nom du fournisseur</label>
                    <div class="read-only" th:text="${facture.supplierName}"></div>
                </div>
                <div class="form-field">
                    <label>Société</label>
                    <div class="read-only" th:text="${facture.company}"></div>
                </div>
                <div class="form-field">
                    <label>Date</label>
                    <div class="read-only" th:text="${#temporals.format(facture.postingDate, 'dd-MM-yyyy')}"></div>
                </div>
                <div class="form-field">
                    <label>Heure de Publication</label>
                    <div class="read-only" th:text="${facture.postingTime}"></div>
                </div>
                <div class="form-field">
                    <label>Date d'Échéance</label>
                    <div class="read-only" th:text="${#temporals.format(facture.dueDate, 'dd-MM-yyyy')}"></div>
                </div>
                <div class="form-field">
                    <label>Statut</label>
                    <div class="highlight" th:text="${facture.status}"></div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">Articles</div>
                <table th:if="${facture.items != null and !facture.items.empty}">
                    <thead>
                        <tr>
                            <th>No.</th>
                            <th>Article</th>
                            <th>Quantité</th>
                            <th>Prix (€)</th>
                            <th>Montant (€)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="item, itemStat : ${facture.items}">
                            <td th:text="${itemStat.count}">1</td>
                            <td th:text="${item.itemName} + ' (' + ${item.itemCode} + ')'"></td>
                            <td th:text="${item.quantity}">78.0</td>
                            <td th:text="${#numbers.formatDecimal(item.rate, 1, 'POINT', 2, 'COMMA') + ' ' + facture.currency}"></td>
                            <td th:text="${#numbers.formatDecimal(item.amount, 1, 'POINT', 2, 'COMMA') + ' ' + facture.currency}"></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="section">
                <div class="section-title">Récapitulatif</div>
                <table>
                    <thead>
                        <tr>
                            <th>Total articles</th>
                            <th>Total HT (€)</th>
                            <th>Total TTC (€)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td th:text="${facture.totalQty}"></td>
                            <td th:text="${#numbers.formatDecimal(facture.netTotal, 1, 'POINT', 2, 'COMMA') + ' ' + facture.currency}"></td>
                            <td th:text="${#numbers.formatDecimal(facture.grandTotal, 1, 'POINT', 2, 'COMMA') + ' ' + facture.currency}"></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="section" th:if="${paiements != null and !paiements.isEmpty()}">
                <div class="section-title">Historique des Paiements</div>
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Référence</th>
                            <th>Montant (€)</th>
                            <th>Moyen</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="p : ${paiements}">
                            <td th:text="${#temporals.format(p.date, 'dd-MM-yyyy')}"></td>
                            <td th:text="${p.reference}"></td>
                            <td th:text="${#numbers.formatDecimal(p.montant, 1, 'POINT', 2, 'COMMA')} + ' ' + p.devise"></td>
                            <td th:text="${p.moyenPaiement}"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="payment-form-container" th:if="${facture.status != 'Paid' and facture.status != 'Payé'}">
            <div class="section">
                <h3>Paiement</h3>

                <div th:if="${success}" class="alert alert-success">
                    <span th:text="${success}"></span>
                </div>
                <div th:if="${error}" class="alert alert-danger">
                    <span th:text="${error}"></span>
                </div>

                <form th:action="@{/paiement/process}" method="post" th:object="${paiementDTO}">
                    <input type="hidden" th:field="*{invoiceName}" th:value="${facture.name}">
                    <input type="hidden" th:field="*{outstandingAmount}" th:value="${facture.outstandingAmount}">
                    <input type="hidden" name="references[0].referenceName" th:value="${facture.name}">
                    <input type="hidden" name="references[0].referenceDoctype" value="Purchase Invoice">
                    <input type="hidden" name="references[0].allocatedAmount" th:value="${facture.outstandingAmount}">
                    <input type="hidden" th:field="*{party}" th:value="${facture.supplierName}">
                    <input type="hidden" th:field="*{currency}" th:value="${facture.currency}">
                    <input type="hidden" th:field="*{company}" th:value="${facture.company}">
                    <input type="hidden" th:field="*{invoiceType}" value="Purchase Invoice">

                    <div class="form-field">
                        <label for="paymentType">Type de paiement *</label>
                        <select id="paymentType" th:field="*{paymentType}" required>
                            <option value="Pay">Payer</option>
                            <option value="Receive">Recevoir</option>
                            <option value="Internal Transfer">Transfert interne</option>
                        </select>
                    </div>
                
                    <div class="form-field">
                        <label for="postingDate">Date de comptabilisation *</label>
                        <input type="date" id="postingDate" th:field="*{postingDate}" required
                               th:value="${#temporals.format(facture.postingDate, 'yyyy-MM-dd')}">
                    </div>
                
                    <!-- Montants -->
                    <div class="form-field">
                        <label for="paidAmount">Montant payé *</label>
                        <input type="number" step="0.01" id="paidAmount" th:field="*{paidAmount}" 
                               th:max="${facture.outstandingAmount}"
                               th:value="${facture.outstandingAmount}" required>
                        <span th:text="${facture.currency}"></span>
                    </div>
                
                    <div class="form-field">
                        <label for="allocatedAmount">Montant alloué *</label>
                        <input type="number" step="0.01" id="allocatedAmount" th:field="*{allocatedAmount}"
                               th:max="${facture.outstandingAmount}"
                               th:value="${facture.outstandingAmount}" required>
                        <span th:text="${facture.currency}"></span>
                    </div>
                
                    <!-- Référence de paiement -->
                    <div class="form-field">
                        <label for="referenceNo">Chèque/N° de Référence *</label>
                        <input type="text" id="referenceNo" th:field="*{referenceNo}" required>
                    </div>
                
                    <div class="form-field">
                        <label for="referenceDate">Date de Référence *</label>
                        <input type="date" id="referenceDate" th:field="*{referenceDate}" required
                               th:value="${#temporals.format(#temporals.createToday(), 'yyyy-MM-dd')}">
                    </div>
                
                    <!-- Comptes bancaires -->
                    <div class="form-field">
                        <label for="paidFrom">Compte Payé Du *</label>
                        <select id="paidFrom" th:field="*{paidFrom}" required>
                            <option value="Bank Account - GD">Bank Account - GD</option>
                            <option value="Cash - GD">Cash - GD</option>
                        </select>
                    </div>
                
                    <div class="form-field">
                        <label for="paidFromAccountCurrency">Devise du compte payé du *</label>
                        <select id="paidFromAccountCurrency" th:field="*{paidFromAccountCurrency}" required>
                            <option value="EURO">EURO</option>
                        </select>
                    </div>
                
                    <div class="form-field">
                        <label for="paidTo">Compte Payé Au *</label>
                        <select id="paidTo" th:field="*{paidTo}" required>
                            <option value="Creditors - GD">Creditors - GD</option>
                        </select>
                    </div>
                
                    <div class="form-field">
                        <label for="paidToAccountCurrency">Devise du compte payé au *</label>
                        <select id="paidToAccountCurrency" th:field="*{paidToAccountCurrency}" required>
                            <option value="EURO">EURO</option>
                        </select>
                    </div>
                
                    <!-- Mode de paiement -->
                    <div class="form-field">
                        <label for="modeOfPayment">Mode de paiement *</label>
                        <select id="modeOfPayment" th:field="*{modeOfPayment}" required>
                            <option value="Cash">Espèces</option>
                            <option value="Bank">Banque</option>
                            <option value="Cheque">Chèque</option>
                        </select>
                    </div>
                
                    <div class="form-field">
                        <button type="submit">Valider le paiement</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</body>
</html>